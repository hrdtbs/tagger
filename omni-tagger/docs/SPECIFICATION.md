# 製品仕様書：OmniTagger (仮称)

## 1. 概要
デスクトップ上のあらゆる視覚情報を、ショートカット操作一つでAIプロンプト（タグ）に変換し、クリップボードへ転送する軽量デスクトップアプリケーション。

## 2. 機能要件

### 2.1 トリガー機能
 * **グローバルホットキー**: アプリがバックグラウンドにある状態で、特定のキー（デフォルト: Alt + Shift + T / Cmd + Shift + T）で発火。
 * **システムトレイ**: 常駐アイコンの右クリックメニューから「画面選択」を開始。

### 2.2 キャプチャ機能
 * **範囲選択モード**: ホットキー押下後、画面全体を静止画として取得し、マウスドラッグで解析範囲を指定。
 * **マルチディスプレイ対応**: 接続されている全てのモニターをキャプチャ対象に含める。

### 2.3 AI解析（Tagger）機能
 * **ローカル推論**: プライバシーと速度のため、外部APIを使わずローカルのONNX Runtimeで実行。
 * **対応モデル**: WD14 Tagger (SwinV2/ConvNext等) を標準搭載。
 * **しきい値調整**: 抽出するタグの確信度（Probability）の下限を設定可能（例: P > 0.35）。

### 2.4 出力機能
 * **クリップボード保存**: 抽出したタグをカンマ区切りのテキストとして即座にコピー。
 * **結果オーバーレイ**: マウスカーソル近傍に抽出されたタグのプレビューを一時的に表示。

## 3. 技術スタック

| 区分 | 選定技術 | 備考 |
|---|---|---|
| フレームワーク | Tauri (v2) | Rust製の軽量コア + Webフロントエンド |
| 言語 | Rust / TypeScript | 高速な画像処理と安全なメモリ管理 |
| 推論エンジン | ONNX Runtime (ort) | CPU/GPUを活用したクロスプラットフォーム推論 |
| 画像処理 | image-rs / screenshots-rs | スクリーンキャプチャと前処理の高速化 |
| UIライブラリ | React + Tailwind CSS | 直感的な設定画面とオーバーレイの構築 |

## 4. システムアーキテクチャ・データフロー
1. **Hotkey Event**: RustコアがOSレベルのイベントを検知。
2. **Screen Capture**: 全画面をバイトデータとして取得し、フロントエンドに転送して「範囲選択UI」を表示。
3. **Preprocessing**: 選択範囲を 448 x 448 ピクセルにリサイズし、RGB正規化を実行。
4. **Inference**: ONNXモデルに入力し、各タグのスコア（0.0 ~ 1.0）を算出。
5. **Post-processing**: 除外タグ（Sensitiveな内容など）をフィルタリングし、文字列に整形。
6. **Action**: pyperclip 相当のRust関数でクリップボードへ書き込み、通知を表示。

## 5. ユーザーインターフェース (UI) 要件

### 5.1 設定画面 (Settings Window)
 * **Model Selection**: 使用するONNXモデルの切り替え。
 * **Tag Formatting**:
   * アンダースコアの有無（long_hair vs long hair）
   * 括弧のエスケープ（画像生成ツール向け）
 * **Exclusion List**: 抽出したくない特定のタグを登録。

### 5.2 選択UI (Selector Overlay)
 * キャプチャ開始時に画面をわずかに暗転（Opacity 0.4）。
 * ドラッグ中の矩形領域をハイライト表示。

## 6. 非機能要件
 * **パフォーマンス**: ホットキー押下からクリップボード完了まで 1秒以内 を目標とする（CPU推論時）。
 * **配布サイズ**: アプリ本体を 100MB以下 に抑制（モデルファイルを除く）。
 * **オフライン動作**: インターネット接続なしで全ての機能が動作すること。
